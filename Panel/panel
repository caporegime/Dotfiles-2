#!/bin/sh

# ObliviousGmn, May 2015
# https://github.com/ObliviousGmn
# Thanks lucafav for ping idea! :)
# Panel for Lemonbar ..

. $HOME/Gmnbox/Panel/bar_config

 ws(){ # Current Workspace .. 
  ws=$(xprop -root _NET_CURRENT_DESKTOP | awk '{print $3}')
	echo "${ws} "
}

 menu(){ # Useless for now ..
	echo "%{B$BLUE}%{F$BG} GMN  %{B-}%{F-}"
}

 temp(){ # CPUs temp ..
  temp=$(sensors | awk '/Core 0/ {print +$3}')
	echo "%{F$BLUE}  %{F-} ${temp}°"
}
	
 fan(){ # Fan speeds ..
  fan=$(sensors | awk '/fan1/ {print $2,$3}')
	echo "%{F$BLUE}  %{F-} ${fan}"
}

 clock(){ # Clock, obv ..
  clock=$(date "+%b %d %Y %I:%M")
	echo "%{F$BLUE}  %{F-} ${clock}"
}

 vol(){ # Volume, Sets to Headset when switched ..
  switch=$(amixer get Master | awk '/Mono:/ {print $6}')
  vol=$(amixer get Master | awk '/Mono:/ {print $4}' | tr -d '[]%,')
  hsvol=$(amixer get PCM | awk '/Mono:/ {print $4}' | tr -d '[]%,')

  if [ "$switch" = "[on]" ]; then
	echo "%{F$BLUE}  %{F-} ${vol}"
  elif [ "$switch" = "[off]" ]; then
	echo "%{F$RED}  %{F-} MUTE"
  else
	echo "%{F$BLUE}  %{F-} ${hsvol} "
  fi
}

 mus(){ # Current song ..
  mus=$(mpc current -f %title%)

  if [[ $mus ]]; then
 	echo "%{F$BLUE}  %{F-} ${mus}"
  fi
}

last(){ # Weechat, Last highlight ..
  last=$((tail -n1) <$HOME/Gmnbox/Panel/Weelog)

  if [[ $last ]]; then
  	echo "%{A:cat /dev/null > $HOME/Gmnbox/Panel/Weelog:}${last}%{A}"
  fi
}

net(){ # Connected or nah? ..
  ping=$(ping 8.8.8.8 -c 1 | awk '/rtt/ {printf("%d\n",$4 + 0.5)}')
  test -n "${ping}" && echo "%{F$BLUE}  %{F-} ${ping}ms" || echo "%{F$BLUE}  %{F-} No Connection"
}

while :; do

 # Looping to slowdown ping ..
 [[ loops -eq 10 ]] && loops=0
 [[ loops -eq 0 ]] && ping=$(net)
 loops=$(( loops + 1 ))

	echo "  $(ws) $(menu) $(vol) $(last) %{c}$(mus) %{r}$(temp) $(fan) $ping $(clock)  "
         sleep 0.5	
		 
done | lemonbar -g ${PW}x${PH}+${PX}+${PY} -f "$FONT1" -f "$FONT4" -B "$BG" -F "$YELLOW" -d -p | \
	while read line; do eval "$line"; done &

